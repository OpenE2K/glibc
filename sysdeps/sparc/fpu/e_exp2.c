/*
 * Copyright 06/12/95 Sun Microsystems, Inc.  All Rights Reserved.
 */

/* exp2(x)
 * Code by K.C. Ng for SUN 4.0 libm.
 * Method :
 *      Write x as  k+j/256+r, where k and j are integer and |r|<1/512.
 *      Then exp2(x) = 2**k * 2**(j/256) * 2**r
 *      Here
 *              2**r = 1 + r*(D1+r*(D2+r*(D3+r*D4)));
 *              2**(j/256) = _TBL_exp2_z[2j] + _TBL_exp2_z[2j+1]
 *      Let q = _TBL_exp2_z[2j]         (the leading part of 2**(j/256))
 *          t = _TBL_exp2_z[2j+1]       (the trailing part)
 *          p = r*(D1+r*(D2+r*(D3+r*D4)))
 *      Then
 *              2**(j/256) * 2**r = (q+t)(1+p) ~ q + (t + q*p)
 *      The actual final computation is then
 *              2**k * (q + (t+q*p))
 *
 * Special cases:
 *      exp2(INF) is INF, exp(NaN) is NaN;
 *      exp2(-INF) = 0;
 *      for finite argument, only exp2(0) = 1 is exact.
 *
 * Accuracy:
 *      according to an error analysis, the error is always less than
 *      an ulp (unit in the last place).
 *
 * _TBL_exp2_z.c (size 512 double)
 *      exp2(j/256) = exp2_z[2j]+exp2_z[2j+1], j=0,...255
 *
 * Constants:
 * The hexadecimal values are the intended ones for the following constants.
 * The decimal values may be used, provided that the compiler will convert
 * from decimal to binary accurately enough to produce the hexadecimal values
 * shown.
 */

#include <math.h>
#include <math_private.h>
#include <math-svid-compat.h>

const double _TBL_exp2_z[] = {
 1.000000000000000000e+00, 0.000000000000000000e+00, 1.002711275050202522e+00,
-3.636615928692263944e-17, 1.005429901112802726e+00, 9.499186535455031757e-17,
 1.008155898118417548e+00,-3.252058756084308061e-17, 1.010889286051700475e+00,
-1.523477860336857718e-17, 1.013630084951489430e+00, 9.283599768183567587e-18,
 1.016378314910953096e+00,-5.772170073199660028e-17, 1.019133996077737914e+00,
 3.601904982259661106e-17, 1.021897148654116627e+00, 5.109225028973443894e-17,
 1.024667792897135721e+00,-7.561607868487778207e-17, 1.027445949118763746e+00,
-4.956074174645369824e-17, 1.030231637686040980e+00, 3.319830041080812944e-17,
 1.033024879021228415e+00, 7.600838874027088489e-18, 1.035825693601957198e+00,
-7.806782391337636167e-17, 1.038634101961378731e+00, 5.996273788852510618e-17,
 1.041450124688316103e+00, 3.784830480287576210e-17, 1.044273782427413755e+00,
 8.551889705537963660e-17, 1.047105095879289793e+00, 7.277077243104314749e-17,
 1.049944085800687210e+00, 5.592937848127002586e-17, 1.052790773004626423e+00,
-9.629482899026935739e-17, 1.055645178360557157e+00, 1.759325738772091984e-18,
 1.058507322794512762e+00,-7.152651856637780738e-17, 1.061377227289262093e+00,
-1.197353708536565756e-17, 1.064254912884464499e+00, 5.078754198611230394e-17,
 1.067140400676823697e+00,-7.899853966841582122e-17, 1.070033711820241873e+00,
-9.937162711288919381e-17, 1.072934867525975555e+00,-3.839668843358823807e-18,
 1.075843889062791048e+00,-1.000271615114413611e-17, 1.078760797757119860e+00,
-6.656660436056592603e-17, 1.081685614993215250e+00,-4.782623902997086266e-17,
 1.084618362213309206e+00, 3.166152845816346116e-17, 1.087559060917769660e+00,
 5.409349307820290759e-18, 1.090507732665257690e+00,-3.046782079812471147e-17,
 1.093464399072885840e+00, 1.441395814726920934e-17, 1.096429081816376883e+00,
-5.919933484449315824e-17, 1.099401802630221914e+00, 7.170459599701923225e-17,
 1.102382583307840891e+00, 5.266036871570694387e-17, 1.105371445701741173e+00,
 8.239288760500213590e-17, 1.108368411723678726e+00,-8.786813845180526616e-17,
 1.111373503344817548e+00, 5.563945026669697643e-17, 1.114386742595892432e+00,
 1.041027845684557095e-16, 1.117408151567369279e+00,-7.976805902628220456e-17,
 1.120437752409606746e+00,-6.201085906554178750e-17, 1.123475567333019898e+00,
-9.699737588987042995e-17, 1.126521618608241848e+00, 5.165856758795456121e-17,
 1.129575928566288079e+00, 6.712805858726256588e-17, 1.132638519598719196e+00,
 3.237356166738000264e-17, 1.135709414157805464e+00, 5.066599926126155242e-17,
 1.138788634756691565e+00, 8.912812676025407778e-17, 1.141876203969561576e+00,
 4.651091177531412387e-17, 1.144972144431804173e+00, 4.641289892170010657e-17,
 1.148076478840178938e+00, 6.897740236627191770e-17, 1.151189229952982673e+00,
 3.250710218863827212e-17, 1.154310420590215935e+00, 1.041712894627326619e-16,
 1.157440073633751121e+00,-9.123871231134400287e-17, 1.160578212027498779e+00,
-3.261040205417393106e-17, 1.163724858777577476e+00, 3.829204836924093499e-17,
 1.166880036952481658e+00,-8.791879579999169742e-17, 1.170043769683250190e+00,
-1.847744201790004694e-18, 1.173216080163637320e+00,-7.287562586584994479e-17,
 1.176396991650281221e+00, 5.554203254218078963e-17, 1.179586527462875845e+00,
 1.009231277510039044e-16, 1.182784710984341014e+00, 1.542975430079076058e-17,
 1.185991565660993841e+00,-9.209506835293105905e-18, 1.189207115002721027e+00,
 3.982015231465646111e-17, 1.192431382583151178e+00, 4.397551415609720827e-17,
 1.195664392039827328e+00, 4.616603670481481397e-17, 1.198906167074380580e+00,
-9.809193356008423118e-17, 1.202156731452703076e+00, 6.644981499252301245e-17,
 1.205416109005123859e+00,-3.357272193267529634e-17, 1.208684323626581625e+00,
-4.746725945228984097e-17, 1.211961399276801243e+00,-4.890611077521118357e-17,
 1.215247359980468955e+00,-7.712630692681488131e-17, 1.218542229827408452e+00,
-9.006726958363837675e-17, 1.221846032972757623e+00,-1.061102121140269116e-16,
 1.225158793637145527e+00,-8.903533814269983429e-17, 1.228480536106870025e+00,
-1.898781631302529953e-17, 1.231811284734075862e+00, 7.389382471610050247e-17,
 1.235151063936933413e+00,-1.075524434430784138e-16, 1.238499898199816540e+00,
 2.767702055573967430e-17, 1.241857812073484002e+00, 4.658027591836936791e-17,
 1.245224830175257980e+00,-4.677240449846727500e-17, 1.248600977189204819e+00,
-8.261810999021963550e-17, 1.251986277866316222e+00, 4.834167152469897600e-17,
 1.255380757024691096e+00,-6.711389821296878419e-18, 1.258784439549716527e+00,
-8.421782587730599357e-17, 1.262197350394250739e+00,-3.084464887473845849e-17,
 1.265619514578806282e+00, 4.250577003450868021e-17, 1.269050957191733220e+00,
 2.667932131342186095e-18, 1.272491703389402762e+00,-1.057791626721242103e-17,
 1.275941778396392001e+00, 9.915430244214290330e-17, 1.279401207505669325e+00,
-9.759095008356062210e-17, 1.282870016078778264e+00, 1.713594918243560968e-17,
 1.286348229546025568e+00,-3.416955706936181976e-17, 1.289835873406665723e+00,
 8.949257530897591722e-17, 1.293332973229089466e+00,-2.974590443132751646e-17,
 1.296839554651009641e+00, 2.538250279488831496e-17, 1.300355643379650594e+00,
 5.678728102802217422e-17, 1.303881265191935812e+00, 8.647675598267871179e-17,
 1.307416445934677318e+00,-7.336645652878868892e-17, 1.310961211524764414e+00,
-7.181536135519453857e-17, 1.314515587949354636e+00, 2.267543315104585645e-17,
 1.318079601266064049e+00,-5.457955827149152886e-17, 1.321653277603157539e+00,
-2.480638245913021742e-17, 1.325236643159741323e+00,-2.858731210038860757e-17,
 1.328829724205954355e+00, 4.089086223910160052e-17, 1.332432547083161500e+00,
-5.101586630916743343e-17, 1.336045138204145832e+00,-5.891866356388801353e-17,
 1.339667524053302916e+00, 8.927282594831731984e-17, 1.343299731186835322e+00,
-5.802580890201437751e-17, 1.346941786232945804e+00, 3.224065101254679169e-17,
 1.350593715892034474e+00,-8.287110381462416533e-17, 1.354255546936892651e+00,
 7.700948379802989462e-17, 1.357927306212901142e+00,-9.529635744825188867e-17,
 1.361609020638224754e+00, 1.533787661270668046e-18, 1.365300717204011915e+00,
-1.000536312597476393e-16, 1.369002422974590516e+00, 9.593797919118848773e-17,
 1.372714165087668414e+00,-4.495960595234841262e-17, 1.376435970754530169e+00,
-6.898588935871801042e-17, 1.380167867260237990e+00, 1.051031457996998395e-16,
 1.383909881963832023e+00,-6.770511658794786287e-17, 1.387662042298529075e+00,
 8.422984274875415318e-17, 1.391424375771926236e+00,-4.906174865288988708e-17,
 1.395196909966200272e+00,-9.329336224225495320e-17, 1.398979672538311236e+00,
-9.614213209051323072e-17, 1.402772691220204759e+00,-5.295783249407989223e-17,
 1.406575993819015435e+00, 7.034914812136422188e-18, 1.410389608217270663e+00,
 4.166548728435061643e-17, 1.414213562373095145e+00,-9.667293313452913451e-17,
 1.418047884320415175e+00, 2.274438542185529452e-17, 1.421892602169165576e+00,
-1.607782891589024413e-17, 1.425747744105494208e+00, 9.880690758500607284e-17,
 1.429613338391970023e+00,-1.203164248905365518e-17, 1.433489413367788901e+00,
-5.802454243926826103e-17, 1.437375997448982368e+00,-4.204034016467556612e-17,
 1.441273119128625657e+00, 5.602503650878985675e-18, 1.445180806977046650e+00,
-3.023758134993987319e-17, 1.449099089642035043e+00,-6.259405000819309254e-17,
 1.453027995849052623e+00,-5.779948609396106102e-17, 1.456967554401443765e+00,
 5.648679453876998140e-17, 1.460917794180647045e+00,-5.600377186075215800e-17,
 1.464878744146405731e+00, 9.530767543587157319e-17, 1.468850433336981842e+00,
 8.465882756533626376e-17, 1.472832890869367528e+00, 6.691774081940589372e-17,
 1.476826145939499346e+00,-3.483994556892795796e-17, 1.480830227822471867e+00,
-9.686952102630618578e-17, 1.484845165872752393e+00, 1.078008676440748076e-16,
 1.488870989524397004e+00, 6.155367157742871330e-17, 1.492907728291264835e+00,
 1.419292015428403577e-17, 1.496955411767235455e+00,-2.861663253899158211e-17,
 1.501014069626425584e+00,-6.413767275790235039e-17, 1.505083731623406473e+00,
 7.074710613582846364e-17, 1.509164427593422841e+00,-1.016455327754295039e-16,
 1.513256187452609813e+00, 8.884497851338712091e-17, 1.517359041198214742e+00,
-4.308699472043340801e-17, 1.521473018908814590e+00,-5.996387675945683420e-18,
 1.525598150744538195e+00, 1.117951878016056987e-16, 1.529734466947286986e+00,
 3.785792115157219037e-17, 1.533881997840955913e+00, 8.875226844438446141e-17,
 1.538040773831656827e+00, 1.017467235116135806e-16, 1.542210825407940744e+00,
 7.949834809697620856e-17, 1.546392183141021448e+00, 1.068396000565721980e-16,
 1.550584877684999974e+00,-1.460070659068938518e-17, 1.554788939777088652e+00,
-8.003161350116035641e-17, 1.559004400237836929e+00, 3.781207053357527502e-17,
 1.563231289971357629e+00, 7.484777645590734389e-17, 1.567469639965552997e+00,
-1.035206176884972199e-16, 1.571719481292341403e+00,-3.342984004687200069e-17,
 1.575980845107886497e+00,-1.013691647127830398e-17, 1.580253762652824578e+00,
-5.163402929554468062e-17, 1.584538265252493749e+00,-1.933771703458570293e-17,
 1.588834384317163950e+00,-5.994950118824479401e-18, 1.593142151342266999e+00,
-1.009440654231196249e-16, 1.597461597908627073e+00, 2.486839279622099921e-17,
 1.601792755682693414e+00,-6.054917453527784343e-17, 1.606135656416771029e+00,
-1.035454528805999526e-16, 1.610490331949254283e+00, 2.470719256979788785e-17,
 1.614856814204860713e+00,-7.316663399125123263e-17, 1.619235135194863728e+00,
 2.094133415422909241e-17, 1.623625327017328868e+00,-3.584512851414474710e-17,
 1.628027421857347834e+00,-6.712955084707084086e-17, 1.632441451987274972e+00,
 9.852819230429992964e-17, 1.636867449766964411e+00, 7.698325071319875575e-17,
 1.641305447644006321e+00,-9.247568737640705508e-17, 1.645755478153964946e+00,
-1.012567991367477260e-16, 1.650217573920617742e+00, 9.133279588729904190e-18,
 1.654691767656194301e+00, 9.643294303196027429e-17, 1.659178092161616158e+00,
-7.275545550823049422e-17, 1.663676580326736376e+00, 5.890992696713099670e-17,
 1.668187265130582464e+00, 4.269178019570614474e-17, 1.672710179641596628e+00,
-5.476715964599563076e-17, 1.677245357017878469e+00, 8.303949509950731553e-17,
 1.681792830507429004e+00, 8.199010020581496520e-17, 1.686352633448393368e+00,
-7.181463278358009442e-17, 1.690924799269305279e+00,-9.669671474394880166e-17,
 1.695509361489332623e+00, 7.238416872845166641e-17, 1.700106353718523478e+00,
-8.023719370397700246e-18, 1.704715809658051251e+00,-2.728883284797281563e-17,
 1.709337763100462926e+00,-9.868779456632931076e-17, 1.713972247929925974e+00,
 6.473975107753367064e-17, 1.718619298122477934e+00,-1.851380418263110988e-17,
 1.723278947746273992e+00,-9.522123800393799963e-17, 1.727951230961837670e+00,
-1.075098186120464245e-16, 1.732636182022311067e+00,-1.698051074315415494e-18,
 1.737333835273706217e+00, 3.164389299292956947e-17, 1.742044225155156445e+00,
-1.525959118950788792e-18, 1.746767386199169048e+00,-1.075229048350751450e-16,
 1.751503353031878207e+00,-5.124450420596724659e-17, 1.756252160373299454e+00,
 2.960140695448873307e-17, 1.761013843037583904e+00,-7.943253125039227711e-17,
 1.765788435933272726e+00, 9.461315018083267867e-17, 1.770575974063554714e+00,
 5.961794510040555848e-17, 1.775376492526521188e+00, 6.429731796556572034e-17,
 1.780190026515424462e+00,-5.284627289091617365e-17, 1.785016611318934965e+00,
 1.533040012103131382e-17, 1.789856282321401038e+00,-4.154354660683349771e-17,
 1.794709075003107168e+00, 1.822745842791208677e-17, 1.799575024940535117e+00,
-2.526889233358897952e-17, 1.804454167806623932e+00,-5.177222408793317883e-17,
 1.809346539371031959e+00,-9.032641402450029682e-17, 1.814252175500398856e+00,
-9.969531538920348820e-17, 1.819171112158608494e+00, 7.402676901145838890e-17,
 1.824103385407053413e+00,-1.015962786227708306e-16, 1.829049031404897274e+00,
 6.889192908835695637e-17, 1.834008086409342431e+00, 3.283107224245626587e-17,
 1.838980586775893711e+00, 6.918969740272511942e-18, 1.843966568958625984e+00,
-5.939742026949964550e-17, 1.848966069510450838e+00, 9.027580446261089288e-17,
 1.853979125083385471e+00, 9.761887490727593538e-17, 1.859005772428820480e+00,
-9.528705461989940687e-17, 1.864046048397788979e+00, 6.540912680620570478e-17,
 1.869099989941238604e+00,-9.938505214255067083e-17, 1.874167634110299963e+00,
-6.122763413004142562e-17, 1.879249018056560194e+00,-1.622631555783584478e-17,
 1.884344179032334532e+00,-8.226593125533710906e-17, 1.889453154390939194e+00,
-9.005168285059125485e-17, 1.894575981586965607e+00, 3.403403535216529671e-17,
 1.899712698176555303e+00,-3.859739769378513707e-17, 1.904863341817674138e+00,
 6.533857514718278629e-17, 1.910027950270389852e+00,-5.909688006744060237e-17,
 1.915206561397147400e+00,-1.061994605619596264e-16, 1.920399213163047403e+00,
 7.116681540630314186e-17, 1.925605943636125028e+00,-9.914963769693740927e-17,
 1.930826790987627106e+00, 6.167149706169109553e-17, 1.936061793492294347e+00,
 1.033238596067632574e-16, 1.941310989528640452e+00,-6.638029891621487990e-17,
 1.946574417579233218e+00, 6.811022349533877184e-17, 1.951852116230978318e+00,
-2.199016969979351086e-17, 1.957144124175400179e+00, 8.960767791036667768e-17,
 1.962450480208927317e+00, 1.097684400091354695e-16, 1.967771223233175881e+00,
-1.031492801153113151e-16, 1.973106392255234320e+00,-7.451617863956037486e-18,
 1.978456026387950928e+00, 4.038875310927816657e-17, 1.983820164850219392e+00,
-2.203454412391062657e-17, 1.989198846967266343e+00, 8.205132638369199416e-18,
 1.994592112170940235e+00, 1.790971035200264509e-17,
};

#define HI(x) *(int*)&x
#define LO(x) *(1+(int*)&x)

static const double px[] = {
    /* exp2(v) ~ 1+v*(D1+v*(D2+v*(D3+v*D4))), where |v|<= 2**-9, pre=2**-58 */
/* D1 = */   6.931471805599391590463305694993282535894e-0001,
/* D2 = */   2.402265069591005782229760567511770004119e-0001,
/* D3 = */   5.550411506821709784853486883814916103240e-0002,
/* D4 = */   9.618129532167256903944369680704221601893e-0003,
/* ZERO       = */ 0.0,
/* BIG        = */ 1.0e300,
/* TINY       = */ 1.0e-300,
/* TWOM100    = */ 7.88860905221011805412e-31,  /* 2**-100 */
/* C256       = */  256.0,
/* INV256     = */  0.00390625,
/* ONE        = */  1.0,
};

#define D1      px[0]
#define D2      px[1]
#define D3      px[2]
#define D4      px[3]
#define ZERO    px[4]
#define BIG     px[5]
#define TINY    px[6]
#define TWOM100 px[7]
#define C256    px[8]
#define INV256  px[9]
#define ONE     px[10]

double
__exp2(double x) {
        double r,p,s,w,t,q;
        int hx,ix,m,k,j,i,lx;
        hx = HI(x); lx = LO(x);
        ix = hx&0x7fffffff;
        i = ix>>20;
        if(i>=0x409) {                          /* |x| >= 1024.0 */
            if(i>=0x7ff) {                      /* x is nan of +-inf */
                if(((hx-0xfff00000)|lx)==0)
                    return ZERO;                /* exp2(-inf)=0 */
                return x+x;                     /* exp2(nan or inf) is nan or inf */
            }
            if(hx>0) return __kernel_standard (x, x, 44);
            if(ix>=0x4090cc00) return __kernel_standard (x, x, 45);     /* x<= -1075 */
        }
    /* tiny x */
        if(i<1014) {            /* |x|<2**-9 */
            if(i<968) {if((int)x==0) return ONE+x;}
            if(i<996) return ONE+x*D1;
            if(i<1003) return ONE+x*(D1+x*D2);
            if(i<1008) return ONE+x*(D1+x*(D2+x*D3));
            return ONE+x*(D1+x*(D2+x*(D3+x*D4)));
        }
        r = x*C256;
    /* check if x is an integer */
        k = i-0x3ff;            /* note that k < 10 */
        i = 20-k;               /* position of binary point */
        j = (ix>>i)<<i;         /* chop off fraction part */
        m = (int)r;
        if((((ix&0x000fffff)>>(i-9))&1)!=0) m+=((m>>31)|1);/* m = r rounded to int*/
        p = (double)m;
    /* if x is an int, do exponent adjustment instead of actual computation */
        if((((unsigned)k>>31)|(j-ix)|lx)==0) {  /* x is an integer */
            if((k=-1022-(m>>8))>0) {            /* underflow or subnormal */
                if(k>52) return TINY*TINY;
                if(k>20)
                    {HI(s)=0; LO(s)=((unsigned)0x80000000)>>(k-21); return s;}
                else
                    {LO(s)=0; HI(s)=(0x00100000)>>k; return s;}
            }
            HI(s) = 0x3ff00000+(m<<12); LO(s)=0; return s;
        }
    /* computing exp2 with table look-up method */
        r = x-p*INV256;
        k = m>>8;
        p = D2+r*(D3+r*D4);
        LO(s) = 0;
        j = (m&0xff)<<1;
        HI(s) = 0x3ff00000+(k<<20);
        p = r*(D1+r*p);
        q = _TBL_exp2_z[j];
        if(m==0) return ONE+p;
        t = _TBL_exp2_z[j+1]+q*p;
        w = t+q;
    /* special care: result may underflow/overflow */
        if(((1023-k)|(k+1021))<0) {     /* if k>1023 or k<-1021 */
           i = HI(w);
           j = (i>>20)+k;
           if(j<=0) {           /* subnormal or underflow */
               if(j<= -54) return TINY*TINY;
               else {
                   k += 100;
                   HI(w) = i+(k<<20);
                   return w*TWOM100;
                }
           } else {
               HI(w) = i+(k<<20);
               return w;
            }
        }
        return s*w;
}

strong_alias (__exp2, __exp2_finite)
weak_alias (__exp2, exp2)
weak_alias (__exp2, __ieee754_exp2)
